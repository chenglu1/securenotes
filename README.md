# ğŸ”’ SecureNotes

> ç¦»çº¿ä¼˜å…ˆã€æ”¯æŒäº‘åŒæ­¥çš„å®‰å…¨ç¬”è®°åº”ç”¨

<p align="center">
  <img src="https://img.shields.io/badge/Electron-28-47848F?logo=electron" />
  <img src="https://img.shields.io/badge/React-19-61DAFB?logo=react" />
  <img src="https://img.shields.io/badge/TypeScript-5-3178C6?logo=typescript" />
  <img src="https://img.shields.io/badge/Vite-5-646CFF?logo=vite" />
  <img src="https://img.shields.io/badge/NestJS-10-E0234E?logo=nestjs" />
  <img src="https://img.shields.io/badge/PostgreSQL-17-4169E1?logo=postgresql" />
  <img src="https://img.shields.io/badge/Tailwind-3.4-38BDF8?logo=tailwindcss" />
</p>

---

## âœ¨ åŠŸèƒ½ç‰¹æ€§

| ç‰¹æ€§ | çŠ¶æ€ | æè¿° |
|------|------|------|
| ğŸ“ **å¯Œæ–‡æœ¬ç¼–è¾‘** | âœ… å·²å®ç° | åŸºäº TipTap çš„ Markdown ç¼–è¾‘å™¨ï¼Œæ”¯æŒæ ‡é¢˜ã€åˆ—è¡¨ã€ä»£ç å—ã€ä»»åŠ¡åˆ—è¡¨ç­‰ |
| ğŸ’¾ **ç¦»çº¿ä¼˜å…ˆ** | âœ… å·²å®ç° | æ•°æ®å­˜å‚¨åœ¨æœ¬åœ° SQLite (sql.js WASM)ï¼Œæ— ç½‘ç»œä¹Ÿå¯æ­£å¸¸ä½¿ç”¨ |
| â˜ï¸ **äº‘åŒæ­¥** | âœ… å·²å®ç° | æ”¯æŒæ³¨å†Œ/ç™»å½•ï¼ŒåŒå‘åŒæ­¥ç¬”è®°åˆ° Neon PostgreSQLï¼Œæ™ºèƒ½å†²çªè§£å†³ |
| ğŸ”„ **ç‰ˆæœ¬æ§åˆ¶** | âœ… å·²å®ç° | åŸºäº sync_version çš„ç‰ˆæœ¬ç®¡ç†ï¼Œä¿æŠ¤æœ¬åœ°æœªæäº¤çš„ä¿®æ”¹ |
| ğŸ” **å…¨æ–‡æœç´¢** | âœ… å·²å®ç° | å³æ—¶æœç´¢ç¬”è®°æ ‡é¢˜å’Œå†…å®¹ |
| ğŸ·ï¸ **æ ‡ç­¾ç³»ç»Ÿ** | âœ… å·²å®ç° | æ”¯æŒåˆ›å»ºæ ‡ç­¾ã€ä¸ºç¬”è®°æ·»åŠ æ ‡ç­¾ |
| ğŸ“ **é™„ä»¶ç®¡ç†** | âœ… å·²å®ç° | æ”¯æŒå›¾ç‰‡ã€PDF ç­‰æ–‡ä»¶é™„ä»¶ |
| ğŸŒ™ **æš—è‰²ä¸»é¢˜** | âœ… å·²å®ç° | ç²¾å¿ƒè®¾è®¡çš„æš—è‰² UIï¼Œä½¿ç”¨ Tailwind CSS å’Œ CSS å˜é‡ |
| ğŸ—‘ï¸ **è½¯åˆ é™¤** | âœ… å·²å®ç° | ç¬”è®°è½¯åˆ é™¤ (deleted_at) æ”¯æŒï¼Œå¯æ¢å¤è¯¯åˆ æ•°æ® |
| ğŸ” **ç«¯åˆ°ç«¯åŠ å¯†** | ğŸš§ è§„åˆ’ä¸­ | ä½¿ç”¨ libsodium åŠ å¯†ï¼ŒæœåŠ¡ç«¯åªå­˜å‚¨å¯†æ–‡ |
| ğŸ”„ **å®æ—¶åä½œ** | ğŸš§ è§„åˆ’ä¸­ | åŸºäº Yjs CRDT çš„å¤šäººå®æ—¶åä½œç¼–è¾‘ |

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Electron Client                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Renderer (React)   â”‚  â”‚   Main Process       â”‚ â”‚
â”‚  â”‚                      â”‚  â”‚                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  TipTap Editor â”‚  â”‚  â”‚  â”‚  IPC Handlers  â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ Zustand Store  â”‚â—„â”€â”¼â”€â”€â”¼â”€â–ºâ”‚   sql.js WASM  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ (Auth + Sync)  â”‚  â”‚  â”‚  â”‚    (SQLite)    â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚  âœ… è½¯åˆ é™¤      â”‚  â”‚ â”‚
â”‚  â”‚          â”‚            â”‚  â”‚  â”‚  âœ… ç‰ˆæœ¬æ§åˆ¶   â”‚  â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚  â”‚  Sync Engine   â”‚  â”‚  â”‚                      â”‚ â”‚
â”‚  â”‚  â”‚  (Pullâ†’Push)   â”‚  â”‚  â”‚                      â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ REST API (JWT)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              NestJS Backend (server/)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ JWT Auth â”‚  â”‚ Sync API  â”‚  â”‚ WebSocket åä½œ    â”‚ â”‚
â”‚  â”‚ âœ… æ³¨å†Œ   â”‚  â”‚ âœ… Pull   â”‚  â”‚ ğŸš§ è§„åˆ’ä¸­        â”‚ â”‚
â”‚  â”‚ âœ… ç™»å½•   â”‚  â”‚ âœ… Push   â”‚  â”‚                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜                  â”‚           â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚           â”‚
â”‚          â”‚ Neon PostgreSQLâ”‚             â”‚           â”‚
â”‚          â”‚   (äº‘æ•°æ®åº“)   â”‚             â”‚           â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç‰¹æ€§è¯´æ˜

#### ğŸ”„ **æ™ºèƒ½äº‘åŒæ­¥**
- **åŒå‘åŒæ­¥**: Pull (äº‘ç«¯â†’æœ¬åœ°) + Push (æœ¬åœ°â†’äº‘ç«¯)
- **å†²çªè§£å†³**: ä¿æŠ¤æœ¬åœ°æœªæäº¤çš„ä¿®æ”¹ (is_dirty æ ‡è®°)
- **ç‰ˆæœ¬æ§åˆ¶**: åŸºäº sync_version çš„å¢é‡æ›´æ–°
- **è‡ªåŠ¨æ¢å¤**: åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ¢å¤ç™»å½•çŠ¶æ€å¹¶æ‹‰å–æ›´æ–°

#### ğŸ’¾ **ç¦»çº¿ä¼˜å…ˆè®¾è®¡**
- **æœ¬åœ°æ•°æ®åº“**: sql.js (WASM SQLite) å­˜å‚¨åœ¨ %APPDATA%/securenotes
- **è„æ•°æ®æ ‡è®°**: is_dirty å­—æ®µæ ‡è®°å¾…åŒæ­¥çš„ç¬”è®°
- **è½¯åˆ é™¤**: deleted_at å­—æ®µæ”¯æŒæ•°æ®æ¢å¤

### æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯ |
|------|------|
| **å‰ç«¯æ¡†æ¶** | React 19 + TypeScript |
| **æ„å»ºå·¥å…·** | Vite 5 + vite-plugin-electron |
| **æ¡Œé¢æ¡†æ¶** | Electron 28 |
| **æ ·å¼æ–¹æ¡ˆ** | Tailwind CSS 3.4 + CSS Variables |
| **ç¼–è¾‘å™¨** | TipTap (ProseMirror) |
| **çŠ¶æ€ç®¡ç†** | Zustand |
| **æœ¬åœ°æ•°æ®åº“** | sql.js (WASM ç‰ˆ SQLite) |
| **åç«¯æ¡†æ¶** | NestJS 10 + TypeORM |
| **äº‘æ•°æ®åº“** | Neon PostgreSQL 17.8 |
| **è®¤è¯** | JWT + bcrypt |
| **åŠ å¯†** | libsodium-wrappers (è§„åˆ’ä¸­) |
| **CRDT** | Yjs (è§„åˆ’ä¸­) |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- **Node.js** >= 18
- **npm** >= 9
- **PostgreSQL** (ä½¿ç”¨ Neon äº‘æ•°æ®åº“ï¼Œæ— éœ€æœ¬åœ°å®‰è£…)

### å®‰è£…ä¸è¿è¡Œ

#### 1. å®¢æˆ·ç«¯ (Electron)

```bash
# å…‹éš†é¡¹ç›®
git clone <repo-url>
cd electron-vite-boilerplate

# å®‰è£…ä¾èµ–
npm install

# å¯åŠ¨å¼€å‘æ¨¡å¼ (Electron + Vite HMR)
npm run dev
```

#### 2. åç«¯æœåŠ¡å™¨ (å¯é€‰ï¼Œå¯ç”¨äº‘åŒæ­¥åŠŸèƒ½)

```bash
# è¿›å…¥æœåŠ¡å™¨ç›®å½•
cd server

# å®‰è£…ä¾èµ–
npm install

# é…ç½® Neon æ•°æ®åº“è¿æ¥ (å‚è§ server/NEON_SETUP.md)
# å¤åˆ¶ .env.example åˆ° .env å¹¶å¡«å†™æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²

# å¯åŠ¨åç«¯æœåŠ¡
npm run dev
```

åç«¯æœåŠ¡å™¨å°†åœ¨ `http://localhost:3000` å¯åŠ¨ã€‚

### ä½¿ç”¨äº‘åŒæ­¥åŠŸèƒ½

1. **æ³¨å†Œè´¦å·**: ç‚¹å‡»å·¦ä¸‹è§’ç™»å½•å›¾æ ‡ â†’ é€‰æ‹©"æ³¨å†Œ" â†’ è¾“å…¥é‚®ç®±å’Œå¯†ç 
2. **ç™»å½•**: è¾“å…¥æ³¨å†Œçš„é‚®ç®±å’Œå¯†ç 
3. **åŒæ­¥**: ç‚¹å‡»å·¦ä¸‹è§’çš„"äº‘åŒæ­¥"æŒ‰é’®ï¼Œè‡ªåŠ¨å®ŒæˆåŒå‘åŒæ­¥
   - å…ˆ Pull: ä»äº‘ç«¯ä¸‹è½½æ›´æ–°
   - å Push: ä¸Šä¼ æœ¬åœ°ä¿®æ”¹åˆ°äº‘ç«¯

**åŒæ­¥ç­–ç•¥**:
- âœ… è‡ªåŠ¨ä¿æŠ¤æœ¬åœ°æœªæäº¤çš„ä¿®æ”¹
- âœ… åŸºäºç‰ˆæœ¬å·çš„æ™ºèƒ½åˆå¹¶
- âœ… åº”ç”¨é‡å¯æ—¶è‡ªåŠ¨æ¢å¤ä¼šè¯å¹¶æ‹‰å–æ›´æ–°

> ğŸ’¡ è¯¦ç»†ä½¿ç”¨æŒ‡å—å‚è§ [CLOUD_SYNC_GUIDE.md](./CLOUD_SYNC_GUIDE.md)

---

## ï¿½ æ–‡æ¡£

- [ğŸ“– GUIDE.md](./GUIDE.md) - **Electron å¼€å‘å®Œæ•´æ•™ç¨‹** (ä»é›¶å¼€å§‹å­¦ä¹  Electronï¼Œæ¨èæ–°æ‰‹é˜…è¯»)
- [â˜ï¸ CLOUD_SYNC_GUIDE.md](./CLOUD_SYNC_GUIDE.md) - **äº‘åŒæ­¥åŠŸèƒ½ä½¿ç”¨æŒ‡å—**
- [ğŸ—„ï¸ server/NEON_SETUP.md](./server/NEON_SETUP.md) - **Neon PostgreSQL é…ç½®æŒ‡å—**

---

## ï¿½ğŸ“ é¡¹ç›®ç»“æ„

```
electron-vite-boilerplate/
â”œâ”€â”€ electron/                    # Electron ä¸»è¿›ç¨‹
â”‚   â”œâ”€â”€ main.ts                  # çª—å£åˆ›å»º + åº”ç”¨ç”Ÿå‘½å‘¨æœŸ
â”‚   â”œâ”€â”€ preload.ts               # contextBridge API (IPC æ¡¥æ¥)
â”‚   â”œâ”€â”€ ipc-handlers.ts          # IPC å¤„ç†å™¨æ³¨å†Œ
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â””â”€â”€ index.ts             # å…±äº«ç±»å‹å®šä¹‰ (Note, Tag, Attachment)
â”‚   â””â”€â”€ database/
â”‚       â”œâ”€â”€ connection.ts        # sql.js åˆå§‹åŒ– + æ–‡ä»¶æŒä¹…åŒ–
â”‚       â””â”€â”€ repositories/
â”‚           â”œâ”€â”€ notes.ts         # ç¬”è®° CRUD + æœç´¢
â”‚           â”œâ”€â”€ tags.ts          # æ ‡ç­¾ CRUD + å…³è”
â”‚           â””â”€â”€ attachments.ts   # é™„ä»¶æ–‡ä»¶ç®¡ç†
â”‚
â”œâ”€â”€ src/                         # æ¸²æŸ“è¿›ç¨‹ (React)
â”‚   â”œâ”€â”€ main.tsx                 # React å…¥å£
â”‚   â”œâ”€â”€ App.tsx                  # æ ¹ç»„ä»¶
â”‚   â”œâ”€â”€ vite-env.d.ts            # ç±»å‹å£°æ˜ (window.api)
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ layout/
â”‚   â”‚   â”‚   â”œâ”€â”€ AppShell.tsx     # ä¸‰æ å¸ƒå±€
â”‚   â”‚   â”‚   â””â”€â”€ Sidebar.tsx      # æœç´¢ + ç¬”è®°åˆ—è¡¨ + åŒæ­¥çŠ¶æ€
â”‚   â”‚   â””â”€â”€ editor/
â”‚   â”‚       â”œâ”€â”€ EditorPane.tsx   # TipTap ç¼–è¾‘å™¨ + è‡ªåŠ¨ä¿å­˜
â”‚   â”‚       â””â”€â”€ EditorToolbar.tsx# æ ¼å¼åŒ–å·¥å…·æ 
â”‚   â”œâ”€â”€ stores/
â”‚   â”‚   â””â”€â”€ noteStore.ts         # Zustand çŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ collaboration.ts     # Yjs æ–‡æ¡£ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ syncEngine.ts        # å¢é‡åŒæ­¥å¼•æ“
â”‚   â”‚   â”œâ”€â”€ cryptoService.ts     # E2E åŠ å¯†æœåŠ¡
â”‚   â”‚   â””â”€â”€ mockApi.ts           # æµè§ˆå™¨å¼€å‘æ¨¡å¼ Mock API
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â””â”€â”€ useCollaboration.ts  # Yjs æ–‡æ¡£ç”Ÿå‘½å‘¨æœŸ Hook
â”‚   â””â”€â”€ styles/
â”‚       â””â”€â”€ index.css            # æš—è‰²ä¸»é¢˜è®¾è®¡ç³»ç»Ÿ
â”‚
â”œâ”€â”€ server/                      # NestJS åç«¯
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ main.ts              # NestJS å¯åŠ¨
â”‚       â”œâ”€â”€ app.module.ts        # æ ¹æ¨¡å— (TypeORM + JWT)
â”‚       â”œâ”€â”€ entities/
â”‚       â”‚   â”œâ”€â”€ note.entity.ts   # ç¬”è®°å®ä½“ (å­˜å‚¨å¯†æ–‡)
â”‚       â”‚   â””â”€â”€ user.entity.ts   # ç”¨æˆ·å®ä½“
â”‚       â”œâ”€â”€ auth/
â”‚       â”‚   â”œâ”€â”€ auth.module.ts
â”‚       â”‚   â”œâ”€â”€ auth.service.ts  # æ³¨å†Œ/ç™»å½• + JWT
â”‚       â”‚   â””â”€â”€ auth.controller.ts
â”‚       â”œâ”€â”€ sync/
â”‚       â”‚   â”œâ”€â”€ sync.module.ts
â”‚       â”‚   â”œâ”€â”€ sync.service.ts  # Push/Pull åŒæ­¥
â”‚       â”‚   â””â”€â”€ sync.controller.ts
â”‚       â””â”€â”€ collaboration/
â”‚           â”œâ”€â”€ collaboration.module.ts
â”‚           â””â”€â”€ collaboration.gateway.ts  # WebSocket ç½‘å…³
â”‚
â”œâ”€â”€ index.html                   # HTML å…¥å£
â”œâ”€â”€ vite.config.ts               # Vite + React + Electron é…ç½®
â”œâ”€â”€ tsconfig.json                # TypeScript é…ç½®
â”œâ”€â”€ package.json
â””â”€â”€ electron-builder.json5       # Electron æ‰“åŒ…é…ç½®
```

---

## ğŸ”§ æ ¸å¿ƒæ¨¡å—è¯´æ˜

### 1. IPC é€šä¿¡

åº”ç”¨ä½¿ç”¨ Electron çš„ `contextBridge` è¿›è¡Œå®‰å…¨çš„è¿›ç¨‹é—´é€šä¿¡ï¼š

```
Renderer (React)         Preload              Main Process
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.api.xxx()  â†’  ipcRenderer.invoke()  â†’  ipcMain.handle()
                                               â”‚
                                               â–¼
                                           Repository
                                               â”‚
                                               â–¼
                                           sql.js DB
```

`window.api` æä¾›çš„æ–¹æ³•ï¼š

| æ–¹æ³• | è¯´æ˜ |
|------|------|
| `getNotes()` | è·å–æ‰€æœ‰æœªåˆ é™¤çš„ç¬”è®° |
| `createNote(data)` | åˆ›å»ºç¬”è®° |
| `updateNote(id, data)` | æ›´æ–°ç¬”è®° (è‡ªåŠ¨æ ‡è®° is_dirty) |
| `deleteNote(id)` | è½¯åˆ é™¤ç¬”è®° (è®¾ç½® deleted_at) |
| `searchNotes(query)` | æœç´¢ç¬”è®°æ ‡é¢˜å’Œå†…å®¹ |
| `getDirtyNotes()` | è·å–æ‰€æœ‰å¾…åŒæ­¥çš„ç¬”è®° (is_dirty=1) |
| `markNoteSynced(id, version)` | æ ‡è®°ç¬”è®°å·²åŒæ­¥ (æ¸…é™¤ is_dirtyï¼Œæ›´æ–° sync_version) |
| `upsertNoteFromCloud(note)` | ä»äº‘ç«¯æ’å…¥/æ›´æ–°ç¬”è®° (æ™ºèƒ½å†²çªè§£å†³) |
| `getTags()` | è·å–æ‰€æœ‰æ ‡ç­¾ |
| `createTag(data)` | åˆ›å»ºæ ‡ç­¾ |
| `addTagToNote(noteId, tagId)` | æ·»åŠ æ ‡ç­¾åˆ°ç¬”è®° |
| `addAttachment(noteId, path)` | æ·»åŠ é™„ä»¶ |

### 2. æ•°æ®åº“ (sql.js)

ä½¿ç”¨ WASM ç‰ˆ SQLiteï¼Œæ— éœ€åŸç”Ÿç¼–è¯‘ï¼š

- **åˆå§‹åŒ–**: åº”ç”¨å¯åŠ¨æ—¶å¼‚æ­¥åŠ è½½ WASM äºŒè¿›åˆ¶
- **æŒä¹…åŒ–**: æ¯æ¬¡å†™æ“ä½œåè°ƒç”¨ `saveDatabase()` å°†å†…å­˜æ•°æ®å†™å…¥ç£ç›˜
- **å­˜å‚¨ä½ç½®**: `%APPDATA%/electron-vite-boilerplate/securenotes.db`

### 3. TipTap ç¼–è¾‘å™¨

ç¼–è¾‘å™¨é…ç½®äº†ä»¥ä¸‹æ‰©å±•ï¼š

| æ‰©å±• | åŠŸèƒ½ |
|------|------|
| `StarterKit` | åŸºç¡€æ ¼å¼ (æ®µè½ã€æ ‡é¢˜ã€åˆ—è¡¨ã€å¼•ç”¨ç­‰) |
| `Placeholder` | ç©ºå†…å®¹æç¤ºæ–‡å­— |
| `Highlight` | æ–‡å­—é«˜äº® |
| `TaskList/TaskItem` | ä»»åŠ¡åˆ—è¡¨ (å¤é€‰æ¡†) |
| `Link` | è¶…é“¾æ¥ (è‡ªåŠ¨æ£€æµ‹) |
| `Image` | å›¾ç‰‡æ’å…¥ |
| `Collaboration` | Yjs CRDT åä½œ (é¢„ç•™) |

### 4. ç«¯åˆ°ç«¯åŠ å¯† (è§„åˆ’ä¸­)

```
ç”¨æˆ·å¯†ç  â†’ Argon2id â†’ ä¸»å¯†é’¥
                        â”‚
                        â–¼
                 ç¬”è®°å†…å®¹ â†’ XSalsa20-Poly1305 åŠ å¯† â†’ å¯†æ–‡
                                                     â”‚
                                                     â–¼
                                              å­˜å‚¨/ä¼ è¾“åˆ°æœåŠ¡å™¨
```

- **å¯†é’¥æ´¾ç”Ÿ**: Argon2id (æŠ— GPU æš´åŠ›ç ´è§£)
- **å¯¹ç§°åŠ å¯†**: XSalsa20-Poly1305 (AEAD)
- **å¯†é’¥åˆ†äº«**: Sealed Box (åŒ¿åå…¬é’¥åŠ å¯†)

**å½“å‰çŠ¶æ€**: äº‘ç«¯æ•°æ®åº“å·²é¢„ç•™ `encrypted_title` å’Œ `encrypted_content` å­—æ®µï¼ŒåŠ å¯†å®ç°å¾…å¼€å‘ã€‚

### 5. åŒæ­¥å¼•æ“ (å·²å®ç°)

```
åº”ç”¨å¯åŠ¨ â†’ initAuth() â†’ æ¢å¤ä¼šè¯ â†’ pullFromCloud()
                                      â†“
æœ¬åœ°ä¿®æ”¹ â†’ æ ‡è®° is_dirty â†’ ç”¨æˆ·ç‚¹å‡»"äº‘åŒæ­¥" â†’ syncToCloud()
                                              â†“
                                    Pull (æ‹‰å–äº‘ç«¯æ›´æ–°)
                                              â†“
                                    æ™ºèƒ½åˆå¹¶ (ä¿æŠ¤æœ¬åœ°è„æ•°æ®)
                                              â†“
                                    Push (ä¸Šä¼ æœ¬åœ°ä¿®æ”¹)
                                              â†“
                                    æ ‡è®°å·²åŒæ­¥ (is_dirty=0)
```

**å†²çªè§£å†³ç­–ç•¥**:
- æœ¬åœ°æœ‰æœªæäº¤ä¿®æ”¹ (is_dirty=1) æ—¶ï¼Œè·³è¿‡äº‘ç«¯æ›´æ–°
- ä»…å½“äº‘ç«¯ç‰ˆæœ¬ä¸¥æ ¼å¤§äºæœ¬åœ°ç‰ˆæœ¬æ—¶æ‰è¦†ç›– (syncVersion > localVersion)

### 6. å®æ—¶åä½œ (è§„åˆ’ä¸­)

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|------|
| `/api/auth/register` | POST | æ³¨å†Œç”¨æˆ· | âœ… å·²å®ç° |
| `/api/auth/login` | POST | ç™»å½•è·å– JWT | âœ… å·²å®ç° |
| `/api/sync/push` | POST | æ¨é€æœ¬åœ°ç¬”è®°å˜æ›´åˆ°äº‘ç«¯ | âœ… å·²å®ç° |
| `/api/sync/notes` | GET | è·å–æ‰€æœ‰äº‘ç«¯ç¬”è®° (Pull) | âœ… å·²å®ç° |
| `/api/sync/pull?since=N` | GET | å¢é‡æ‹‰å–æ›´æ–° | ğŸš§ è§„åˆ’ä¸­ |
| WebSocket `/collaboration` | - | å®æ—¶åä½œ (Yjs æ›´æ–°è½¬å‘) | ğŸš§ è§„åˆ’ä¸­ |

**å·²å®ç°çš„åŒæ­¥æµç¨‹**:
```
1. å®¢æˆ·ç«¯è°ƒç”¨ pullFromCloud()
   â†’ GET /api/sync/notes (è·å–æ‰€æœ‰äº‘ç«¯ç¬”è®°) 
   â†’ æœ¬åœ° upsertNoteFromCloud() (æ™ºèƒ½åˆå¹¶)
   
2. å®¢æˆ·ç«¯è°ƒç”¨ syncToCloud()
   â†’ å…ˆæ‰§è¡Œ Pull åŒæ­¥
   â†’ å†è·å–æœ¬åœ° dirty notes
   â†’ POST /api/sync/push (æ‰¹é‡ä¸Šä¼ )
   â†’ æ ‡è®°å·²åŒæ­¥ (is_dirty=0)
```

---

## ğŸ› ï¸ å¼€å‘æŒ‡å—

### å¸¸ç”¨å‘½ä»¤

```bash
npm run dev          # å¯åŠ¨å¼€å‘ (Vite HMR + Electron)
npm run build        # æ„å»ºç”Ÿäº§ç‰ˆæœ¬ + æ‰“åŒ… Electron
npm run preview      # é¢„è§ˆæ„å»ºç»“æœ
```

### æ·»åŠ æ–°çš„ IPC æ–¹æ³•

1. åœ¨ `electron/types/index.ts` æ·»åŠ ç±»å‹
2. åœ¨å¯¹åº”çš„ `repositories/` ä¸­æ·»åŠ æ•°æ®æ“ä½œæ–¹æ³•
3. åœ¨ `electron/ipc-handlers.ts` æ³¨å†Œ `ipcMain.handle`
4. åœ¨ `electron/preload.ts` æš´éœ²æ–¹æ³•åˆ° `window.api`
5. åœ¨ `src/services/mockApi.ts` æ·»åŠ å¯¹åº”çš„ mock å®ç°

### æ·»åŠ æ–°çš„ç¼–è¾‘å™¨åŠŸèƒ½

1. å®‰è£… TipTap æ‰©å±•: `npm install @tiptap/extension-xxx`
2. åœ¨ `EditorPane.tsx` çš„ `extensions` æ•°ç»„ä¸­æ³¨å†Œ
3. åœ¨ `EditorToolbar.tsx` æ·»åŠ å·¥å…·æ æŒ‰é’®

### æµè§ˆå™¨å¼€å‘æ¨¡å¼

ç›´æ¥è®¿é—® `http://localhost:5173` å¯ä»¥åœ¨æµè§ˆå™¨ä¸­é¢„è§ˆ UIï¼Œæ— éœ€å¯åŠ¨ Electronã€‚æ­¤æ¨¡å¼ä½¿ç”¨ `mockApi.ts` æä¾›çš„å†…å­˜æ•°æ®ï¼Œä¸æŒä¹…åŒ–ã€‚

---

## ğŸ“¦ æ„å»ºä¸æ‰“åŒ…

```bash
# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build
```

ç”Ÿæˆæ–‡ä»¶ä½äº `release/` ç›®å½•ã€‚æ‰“åŒ…é…ç½®è§ `electron-builder.json5`ã€‚

---

## ğŸ¤ å®æ—¶åä½œ (è§„åˆ’ä¸­)

> âš ï¸ **å¼€å‘çŠ¶æ€**: åç«¯å·²é¢„ç•™ WebSocket ç½‘å…³ï¼Œå‰ç«¯åä½œåŠŸèƒ½å¾…å®ç°

```mermaid
graph LR
  A[ç”¨æˆ· A ç¼–è¾‘] --> B[Yjs ç”Ÿæˆ Update]
  B --> C[WebSocket å‘é€]
  C --> D[æœåŠ¡ç«¯è½¬å‘]
  D --> E[ç”¨æˆ· B æ¥æ”¶]
  E --> F[Yjs åˆå¹¶ CRDT]
  F --> G[UI è‡ªåŠ¨æ›´æ–°]
```

**è®¾è®¡æ–¹æ¡ˆ**:
1. æ¯ä¸ªç¬”è®°å¯¹åº”ä¸€ä¸ª `Y.Doc` å®ä¾‹
2. ç¼–è¾‘æ“ä½œç”Ÿæˆ Yjs Update (å¢é‡äºŒè¿›åˆ¶)
3. é€šè¿‡ WebSocket è½¬å‘ç»™åŒä¸€ç¬”è®°çš„å…¶ä»–åä½œè€…
4. CRDT ç®—æ³•è‡ªåŠ¨è§£å†³å†²çªï¼Œæ— éœ€æ‰‹åŠ¨åˆå¹¶

---

## ğŸ“‹ æ•°æ®åº“è¡¨ç»“æ„

### æœ¬åœ°æ•°æ®åº“ (SQLite - sql.js)

```sql
-- ç¬”è®°
CREATE TABLE notes (
  id            TEXT PRIMARY KEY,     -- UUID
  title         TEXT DEFAULT '',
  content       TEXT DEFAULT '',      -- TipTap HTML
  created_at    TEXT,
  updated_at    TEXT,
  deleted_at    TEXT,                 -- è½¯åˆ é™¤ (NULL = æ´»è·ƒ)
  sync_version  INTEGER DEFAULT 0,    -- äº‘ç«¯ç‰ˆæœ¬å·
  is_dirty      INTEGER DEFAULT 1     -- å¾…åŒæ­¥æ ‡è®° (1 = æœ‰æœ¬åœ°ä¿®æ”¹)
);

-- æ ‡ç­¾
CREATE TABLE tags (
  id    TEXT PRIMARY KEY,
  name  TEXT UNIQUE,
  color TEXT DEFAULT '#6366f1'
);

-- ç¬”è®°-æ ‡ç­¾å…³è”
CREATE TABLE note_tags (
  note_id TEXT REFERENCES notes(id),
  tag_id  TEXT REFERENCES tags(id),
  PRIMARY KEY (note_id, tag_id)
);

-- é™„ä»¶
CREATE TABLE attachments (
  id          TEXT PRIMARY KEY,
  note_id     TEXT REFERENCES notes(id),
  filename    TEXT,
  mime_type   TEXT,
  size_bytes  INTEGER,
  file_path   TEXT,                   -- userData ä¸‹çš„ç›¸å¯¹è·¯å¾„
  created_at  TEXT
);
```

### äº‘æ•°æ®åº“ (PostgreSQL - Neon)

```sql
-- ç”¨æˆ·
CREATE TABLE users (
  id         SERIAL PRIMARY KEY,
  email      VARCHAR(255) UNIQUE NOT NULL,
  password   VARCHAR(255) NOT NULL,       -- bcrypt å“ˆå¸Œ
  created_at TIMESTAMP DEFAULT NOW()
);

-- ç¬”è®° (ä»…å­˜å‚¨å·²æäº¤çš„ç‰ˆæœ¬)
CREATE TABLE notes (
  id              UUID PRIMARY KEY,
  user_id         INTEGER REFERENCES users(id),
  title           TEXT,
  content         TEXT,                    -- TipTap HTML
  encrypted_title TEXT,                    -- é¢„ç•™åŠ å¯†å­—æ®µ
  encrypted_content TEXT,                  -- é¢„ç•™åŠ å¯†å­—æ®µ
  created_at      TIMESTAMP,
  updated_at      TIMESTAMP,
  deleted_at      TIMESTAMP,               -- è½¯åˆ é™¤
  sync_version    INTEGER DEFAULT 1        -- æ¯æ¬¡ä¿®æ”¹ +1
);
```

---

## ğŸ“„ License

MIT
